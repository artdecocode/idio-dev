{"version":3,"sources":["../../src/watch-routes/index.js"],"names":["fsevents","require","e","log","console","findChildrenInCache","dir","file","path","item","cache","children","res","map","id","getDisplayPath","url","route","pad","key","maxLength","length","a","Array","from","join","grey","t","methods","router","defaultImports","aliases","Error","Object","keys","forEach","m","method","longestKey","reduce","acc","k","d","watcher","on","onChange","start","filter","c","test","w","p","rel","split","sep","name","layer","fn","stack","find","_route","i","indexOf","newFn","reloadedAliases","alias","aliasName","l","fun","j"],"mappings":"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","sourcesContent":["import { resolve, relative, sep } from 'path'\nimport { getName, removeExtension, importRoute } from 'idio/build/lib/routes'\n\nlet fsevents\ntry {\n  fsevents = require('fsevents')\n} catch (e) { /* ignore fsevents */ }\n\nconst log = console.log\n\nconst findChildrenInCache = (dir, file) => {\n  const path = resolve(dir, file)\n  const item = require.cache[path]\n  if (!item) return []\n  const { children } = item\n  const res = children.map(({ id }) => id)\n  return res\n}\n\nconst getDisplayPath = (url, route) => {\n  return `${url}${route}`\n}\n\nconst pad = (key, maxLength) => {\n  const length = maxLength - key.length\n  const a = Array.from({ length }).map(a => ' ').join('')\n  return `${key}${a}`\n}\n\nconst grey = (t) => {\n  return `\\x1b[90m${t}\\x1b[0m`\n}\n\n/**\n * Watch routes.\n */\nexport default ({ dir, methods, router, defaultImports = true, aliases = {}, url = '' }) => {\n  if (!fsevents) {\n    throw new Error('fsevetns is not installed')\n  }\n  Object.keys(methods).forEach((m) => {\n    const method = methods[m]\n    const keys = Object.keys(method)\n    const { length: longestKey } = keys.reduce((acc, k) => {\n      if (k.length > acc.length)\n        return k\n      return acc\n    }, '')\n    keys.forEach(key => {\n      const d = getDisplayPath(url, key)\n\n      const { path } = method[key]\n      const watcher = fsevents(path)\n      log('%s', pad(d, longestKey + url.length))\n      log('  %s', relative('', path))\n      watcher.on('modified', () => {\n        log('⌁ %s', relative('', path))\n        onChange(path, dir, router, defaultImports, aliases)\n      })\n      watcher.start()\n\n      const children = findChildrenInCache('', path)\n      children.filter((c) => {\n        return !/node_modules/.test(c)\n      }).forEach((c) => {\n        const w = fsevents(c)\n        log('  %s', grey(relative('', c)))\n        w.on('modified', (p) => {\n          log('⌁ %s', grey(relative('', p)))\n          onChange(path, dir, router, defaultImports, aliases)\n        })\n        w.start()\n      })\n    })\n  })\n}\n\nconst onChange = (path, dir, router, defaultImports, aliases) => {\n  const rel = relative(dir, path)\n  const [method, file] = rel.split(sep)\n  const route = `/${removeExtension(file)}`\n  const name = getName(method, route)\n  const layer = router.route(name)\n  const fn = layer.stack.find(({ _route }) => _route == true)\n  if (!fn) return\n  const i = layer.stack.indexOf(fn)\n  const children = findChildrenInCache('', path)\n  children.forEach((c) => {\n    delete require.cache[c]\n  })\n  delete require.cache[path]\n  const { fn: newFn } = importRoute(dir, rel, defaultImports)\n  layer.stack[i] = newFn\n\n  const a = aliases[method][route] || []\n  const reloadedAliases = a.map((alias) => {\n    const aliasName = getName(method, alias)\n    const l = router.route(aliasName)\n    const fun = l.stack.find(({ _route }) => _route == true)\n    if (!fun) return\n    const j = l.stack.indexOf(fun)\n    l.stack[j] = newFn\n    return aliasName\n  })\n\n  console.log('> hot reloaded %s %s', name, reloadedAliases.length ? `${reloadedAliases.join(', ')}` : '')\n}\n"],"file":"index.js"}